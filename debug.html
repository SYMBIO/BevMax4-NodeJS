<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Arnie++</title>
        <meta name="description" content="Beer Vending Machine">

        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <style>
        pre {
            width:50%;
        }
        #sessionStatus {
            color:red;
        }
        #sessionStatus.active {
            color: green;
        }
    </style>
    <script>


    var alreadyConnected=false;
    var sessionStarted = false;

        $(function(){

            if(!alreadyConnected){

                $.ajax({
                    url: "/connect",
                    cache: false,
                    type: 'GET'
                }).done(function(data) {
                    alreadyConnected=true;
                    console.log("connected to machine", data);
                });
                // $.get("/connect")
                //     .done(function(data) {
                //         alreadyConnected=true;
                //         console.log("connected to machine", data);
                //     });
            }

            $('#sessionToggle').click(toggleSession);

            function toggleSession() {
                console.log('debug.html: sessionStarted', sessionStarted);
                // Turn on session
                if (!sessionStarted) {
                    $.ajax({
                        url: "/startsession",
                        cache: false,
                        type: 'GET'
                    }).done(function(data) {
                        sessionStarted = true;
                        $('#sessionStatus').addClass('active').text('Session Active');
                        console.log("debug.html: started session", data);
                    });
                } else {
                    $.ajax({
                        url: "/endsession",
                        cache: false,
                        type: 'GET'
                    }).done(function(data) {
                        sessionStarted = false;
                        $('#sessionStatus').removeClass('active').text('Session Inactive');
                        console.log("debug.html: ended session", data);
                    });
                };
                // if (!sessionStarted) {
                //     $.get("/startsession")
                //         .done(function(data) {
                //             sessionStarted = true;
                //             $('#sessionStatus').addClass('active').text('Session Active');
                //             console.log("debug.html: started session", data);
                //         });
                // } else {
                //     $.get("/endsession")
                //         .done(function(data) {
                //             sessionStarted = false;
                //             $('#sessionStatus').removeClass('active').text('Session Inactive');
                //             console.log("debug.html: ended session", data);
                //         });
                // };
            }

            // Submit the debug form
            $('#debugForm').submit(function(event){
                var hex = $(this).find(':input').val();
                $('#request').text("You entered: "+hex);

                $.ajax({
                    url: "sendRequest",
                    data: {"hex":hex}
                }).done(function(data, textStatus, jqXHR){
                    $('#response').text(data);
                    console.log('success data',data);
                    console.log('success textStatus',textStatus);
                    console.log('success jqXHR',jqXHR);
                }).fail(function(jqXHR, textStatus, errorThrown){
                    console.log('fail jqXHR',jqXHR);
                    console.log('fail textStatus',textStatus);
                    console.log('fail errorThrown',errorThrown);
                    $('#response').text(jqXHR.responseText);
                })
                event.preventDefault();
            });

        });


       </script>
    </head>
    <body>
        <h1>Debug Terminal</h1>
        <p>Send Hex Codes to PC2MDB cashless device. First turn on a session using the button below</p>
        <p><button id="sessionToggle">Toggle Session</button> <span id="sessionStatus">Session Inactive</span></p>
        <form id="debugForm">
            <input type="text" name="hex">
            <input type="submit">
        </form>
        <h2>Request</h2>
        <p id="request"></p>
        <h2>Response</h2>
        <pre id="response"></pre>
    </body>
</html>
